#cloud-config
hostname: #OVERVIEW_ENVIRONMENT#-worker
repo_update: true
repo_upgrade: all
packages:
  - awscli
  - ca-certificates
  - ca-certificates-java
  - libreoffice
  - openjdk-8-jre-headless
  - rsyslog-relp
  - tesseract-ocr
  - tesseract-ocr-ara
  - tesseract-ocr-cat
  - tesseract-ocr-deu
  - tesseract-ocr-fra
  - tesseract-ocr-ita
  - tesseract-ocr-nld
  - tesseract-ocr-por
  - tesseract-ocr-rus
  - tesseract-ocr-spa
  - tesseract-ocr-swe
  - unzip
write_files:
  - path: /etc/rsyslog.d/39-logstash.conf
    content: |
      $ModLoad omrelp
      *.* :omrelp:10.79.180.239:2514
  - path: /etc/init/overview-worker.conf
    content: |
      description "Overview worker"
      author "Overview Project"
      setuid overview
      setgid overview
      chdir /opt/overview
      console output
      respawn
      exec /opt/overview/run-worker.sh worker JobHandler local1.notice 3000m
  - path: /etc/systemd/system/overview-worker.conf
    content: |
      [Unit]
      Description=Overview worker

      [Install]
      WantedBy=multi-user.target

      [Service]
      Restart=on-failure
      RootDirectory=/opt/overview
      User=overview
      Type=simple
      ExecStartPre=/bin/bash /opt/overview/prepare-worker.sh documentset-worker
      ExecStart=/bin/bash /opt/overview/run-worker.sh documentset-worker com.overviewdocs.DocumentSetWorker local2.notice 2500m
  - path: /etc/systemd/system/overview-documentset-worker.conf
    content: |
      [Unit]
      Description=Overview document-set worker

      [Install]
      WantedBy=multi-user.target

      [Service]
      Restart=on-failure
      RootDirectory=/opt/overview
      User=overview
      Type=simple
      ExecStartPre=/bin/bash /opt/overview/prepare-worker.sh worker
      ExecStart=/bin/bash /opt/overview/run-worker.sh documentset-worker com.overviewdocs.DocumentSetWorker local2.notice 2500m
  - path: /opt/overview/prepare-worker.sh
    permissions: '0755'
    content: |
      #!/bin/bash

      SERVER=$1 # "worker" or "documentset-worker"

      aws s3 cp s3://overview-#OVERVIEW_ENVIRONMENT#-secrets/worker-env.sh /opt/overview/$SERVER-env.sh
      aws s3 cp s3://overview-builds/#OVERVIEW_ENVIRONMENT#.zip /tmp/$SERVER-archive.zip
      FILENAMES=$(unzip -qq -p /tmp/$SERVER-archive.zip archive/$SERVER/classpath.txt | sed -e 's/^/archive\/lib\//')
      rm -rf /opt/overview/$SERVER
      unzip -qq -d /opt/overview/$SERVER -j /tmp/$SERVER-archive.zip $FILENAMES

      rm -f /tmp/$SERVER-archive.zip
  - path: /opt/overview/run-worker.sh
    permissions: '0755'
    content: |
      #!/bin/bash

      SERVER=$1 # "worker" or "documentset-worker"
      MAIN_CLASS=$2 # "JobHandler" or "com.overviewdocs.DocumentSetWorker"
      SYSLOG_OUTPUT=$3 # "local1.notice" or "local2.notice"
      MAX_MEMORY=$4 # "3000m" or "2500m"

      source /opt/overview/$SERVER-env.sh

      exec /usr/bin/java \
        -cp "/opt/overview/$SERVER/*" \
        -Dfile.encoding=UTF8 \
        -Dconfig.resource=production.conf \
        -Dlogback.configurationFile=workerprodlog.xml \
        -Duser.timezone=UTC \
        -Xmx$MAX_MEMORY \
        $MAIN_CLASS \
        2>&1 | logger -p "$SYSLOG_OUTPUT"
users:
  - default
  - name: overview
    home: /opt/overview
runcmd:
  - env DEBIAN_FRONTEND=noninteractive apt-get -qq -y remove --purge openjdk-7-jre openjdk-7-jre-headless # ca-certificates-java puts it there in an apt-dependency vortex of uselessness
  - /var/lib/dpkg/info/ca-certificates-java.postinst configure # https://bugs.launchpad.net/ubuntu/+source/ca-certificates-java/+bug/1396760
  - chown overview:overview /opt/overview -R
  - echo "127.0.1.1 $(hostname)" | sudo tee -a /etc/hosts
  - systemctl stop syslog
  - systemctl start syslog
  - systemctl start overview-worker
  - systemctl start documentset-worker
