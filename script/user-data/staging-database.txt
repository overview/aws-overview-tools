#cloud-config
hostname: staging-database
repo_update: true
repo_upgrade: all
packages:
  - rsyslog-relp
  - postgresql-9.4
  - postgresql-contrib-9.4
write_files:
  - path: /etc/rsyslog.d/39-logstash.conf
    content: |
      $ModLoad omrelp
      *.* :omrelp:10.79.180.239:2514
  - path: /etc/postgresql/9.4/main/pg_hba.conf
    content: |
      local all postgres peer
      local all all peer
      host overview overview 10.0.0.0/8 md5
  - path: /etc/postgresql/9.4/main/postgresql.conf
    content: |
      checkpoint_segments = 30
      data_directory = '/var/lib/postgresql/9.4/main'
      datestyle = 'iso, ymd'
      dynamic_shared_memory_type = posix
      external_pid_file = '/var/run/postgresql/9.4-main.pid'
      hba_file = '/etc/postgresql/9.4/main/pg_hba.conf'
      ident_file = '/etc/postgresql/9.4/main/pg_ident.conf'
      listen_addresses = '*'
      log_line_prefix = '%t '
      log_min_duration_statement = 500
      log_timezone = 'UTC'
      maintenance_work_mem = 1GB
      max_connections = 50
      port = 5432
      shared_buffers = 128MB
      synchronous_commit = off
      timezone = 'UTC'
      unix_socket_directories = '/var/run/postgresql'
      work_mem = 128MB
mounts:
  - [ xvdf, /var/lib/postgresql ]
mount_default_fields: [ None, None, 'auto', 'defaults,nobootwait', '0', '2' ]
runcmd:
  - echo "127.0.1.1 $(hostname)" | sudo tee -a /etc/hosts
  - /etc/init.d/rsyslog stop
  - /etc/init.d/rsyslog start
  - /etc/init.d/postgresql stop
  - chown postgres:postgres /var/lib/postgresql /etc/postgresql -R
  - /etc/init.d/postgresql start
  - sudo -u postgres psql overview -c "UPDATE file SET contents_location = REPLACE(contents_location, 's3:overview-production-', 's3:overview-staging-')"
  - sudo -u postgres psql overview -c "UPDATE file SET view_location = REPLACE(view_location, 's3:overview-production-', 's3:overview-staging-')"
  - sudo -u postgres psql overview -c "UPDATE page SET data_location = REPLACE(data_location, 's3:overview-production-', 's3:overview-staging-')"
