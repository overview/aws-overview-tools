#cloud-config
hostname: staging-web
repo_update: true
repo_upgrade: all
packages:
  - rsyslog-relp
  - openjdk-8-jre-headless
  - redis-server
  - haproxy
  - awscli
write_files:
  - path: /etc/default/haproxy
    content: |
      ENABLED=1
  - path: /etc/haproxy/haproxy.cfg
    content: |
      global
        log /dev/log local0
        user haproxy
        group haproxy

      defaults
        log global
        option httplog
        option http-server-close
        option forwardfor
        maxconn 4096

      frontend http_redirect
        mode http
        bind 0.0.0.0:80
        timeout client 50s
        redirect prefix https://staging.overviewproject.org code 301 

        capture request header Host len 40
        capture request header X-Forwarded-For len 50
        capture request header Accept-Language len 50
        capture request header Referer len 200
        capture request header User-Agent len 200

        capture response header Content-Type len 30
        capture response header Content-Encoding len 10
        capture response header Cache-Control len 200
        capture response header Last-Modified len 200

      frontend overview_frontend
        mode http

        # Keys from https://wiki.mozilla.org/Security/Server_Side_TLS
        bind 0.0.0.0:443 ssl crt /etc/haproxy/ssl.pem ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK

        timeout client 50s

        acl canonical_url hdr_dom(Host) eq staging.overviewproject.org
        redirect prefix https://staging.overviewproject.org code 301 if !canonical_url

        # Add the HSTS header with a 1 year max-age
        rspadd Strict-Transport-Security:\ max-age=31536000

        default_backend overview_backend

        capture request header Host len 40
        capture request header X-Forwarded-For len 50
        capture request header Accept-Language len 50
        capture request header Referer len 200
        capture request header User-Agent len 200

        capture response header Content-Type len 30
        capture response header Content-Encoding len 10
        capture response header Cache-Control len 200
        capture response header Last-Modified len 200

      backend overview_backend
        mode http
        timeout connect 5s
        timeout server 120s

        server overview 127.0.0.1:9000
  - path: /etc/rsyslog.d/39-logstash.conf
    content: |
      $ModLoad omrelp
      *.* :omrelp:10.79.180.239:2514
  - path: /etc/redis/redis.conf
    content: |
      daemonize yes
      bind 0.0.0.0
      pidfile /var/run/redis/redis-server.pid
      port 6379
      timeout 0
      loglevel notice
      syslog-enabled yes
      syslog-ident redis
      syslog-facility local1
      maxmemory 1GB
      maxmemory-samples 5
      slowlog-log-slower-than 10000
      slowlog-max-len 128
runcmd:
  - echo "127.0.1.1 $(hostname)" | sudo tee -a /etc/hosts
  - /etc/init.d/rsyslog stop
  - /etc/init.d/rsyslog start
  - /etc/init.d/redis-server restart
  - aws s3 cp s3://overview-staging-secrets/ssl.pem /etc/haproxy/ssl.pem
  - /etc/init.d/haproxy restart
